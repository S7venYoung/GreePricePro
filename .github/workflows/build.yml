on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Package
    runs-on: macos-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Build with Swift
      # 编译通用架构 (Intel + Apple Silicon)
      run: swift build -c release --arch arm64 --arch x86_64

    - name: Create App Bundle
      run: |
        APP_NAME="GreePricePro"
        
        # 1. 创建 App 结构
        mkdir -p build/$APP_NAME.app/Contents/MacOS
        mkdir -p build/$APP_NAME.app/Contents/Resources
        
        # 2. 定位二进制文件 (增加容错逻辑)
        # 优先查找通用构建路径
        BINARY_PATH="./.build/apple/Products/Release/$APP_NAME"
        
        if [ ! -f "$BINARY_PATH" ]; then
            echo "Standard path not found, searching..."
            # 暴力搜索 .build 目录下名为 GreePricePro 的可执行文件
            BINARY_PATH=$(find .build -name "$APP_NAME" -type f -perm +0111 | grep -v "\.o$" | head -n 1)
        fi
        
        if [ -z "$BINARY_PATH" ] || [ ! -f "$BINARY_PATH" ]; then
          echo "Error: Binary not found in .build directory!"
          # 列出目录结构以便调试
          find .build -maxdepth 4
          exit 1
        else
          echo "Found binary at: $BINARY_PATH"
          cp "$BINARY_PATH" "build/$APP_NAME.app/Contents/MacOS/"
        fi

        # 3. 创建 Info.plist
        cat <<PLIST > build/$APP_NAME.app/Contents/Info.plist
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>$APP_NAME</string>
            <key>CFBundleIconFile</key>
            <string>AppIcon</string>
            <key>CFBundleIdentifier</key>
            <string>com.greehelper.$APP_NAME</string>
            <key>CFBundleName</key>
            <string>$APP_NAME</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>LSMinimumSystemVersion</key>
            <string>13.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        PLIST

    - name: Zip App
      run: |
        cd build
        zip -r GreePricePro.zip GreePricePro.app

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: GreePricePro-App
        path: build/GreePricePro.zip
