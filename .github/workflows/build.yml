name: Build macOS App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Package
    runs-on: macos-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Build with Swift
      # 编译通用架构 (Intel + Apple Silicon)
      run: swift build -c release --arch arm64 --arch x86_64

    - name: Create App Bundle
      run: |
        APP_NAME="GreePricePro"
        # 1. 手动创建 .app 文件夹结构
        mkdir -p build/$APP_NAME.app/Contents/MacOS
        mkdir -p build/$APP_NAME.app/Contents/Resources
        
        # 2. 查找编译好的二进制文件 (忽略中间文件，只找 release 目录下的最终产物)
        BINARY_PATH=$(find .build -type f -name "$APP_NAME" | grep "release" | head -n 1)
        
        if [ -z "$BINARY_PATH" ]; then
          echo "Error: Binary not found!"
          exit 1
        else
          echo "Found binary at: $BINARY_PATH"
          cp "$BINARY_PATH" "build/$APP_NAME.app/Contents/MacOS/"
        fi

        # 3. 创建 Info.plist (这是 App 能被 macOS 识别的关键)
        cat <<PLIST > build/$APP_NAME.app/Contents/Info.plist
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>$APP_NAME</string>
            <key>CFBundleIconFile</key>
            <string>AppIcon</string>
            <key>CFBundleIdentifier</key>
            <string>com.greehelper.$APP_NAME</string>
            <key>CFBundleName</key>
            <string>$APP_NAME</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>LSMinimumSystemVersion</key>
            <string>13.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        PLIST

    - name: Zip App
      run: |
        cd build
        zip -r GreePricePro.zip GreePricePro.app

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: GreePricePro-App
        path: build/GreePricePro.zip
